<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MEE•MO•MEME MACHINE (v4.7.9)</title>
<style>
  :root{ --bg:#0f0f10; --panel:#16171a; --ink:#e9e9ea; --brand:#ca3028; --pink:#ff4fb0; }
  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{ margin:0; background:var(--bg); color:var(--ink); font-family:Inter,system-ui,Segoe UI,Roboto,Arial; }
  .app{ display:grid; grid-template-rows:auto 1fr; height:100% }

  .top{ display:grid; grid-template-columns:auto 1fr auto; gap:10px; align-items:center; padding:10px 14px; background:#111214; border-bottom:1px solid #23252a }
  .btn, select, input[type=color], input[type=range]{ background:#23252a; color:var(--ink); border:1px solid #2f3238; border-radius:10px; height:34px; padding:0 10px; cursor:pointer; font-size:13px }
  .btn{ display:inline-flex; align-items:center; justify-content:center; padding:6px 10px; height:34px }
  .brand{ display:flex; align-items:center; justify-content:center; gap:10px; font-weight:900; letter-spacing:.5px; pointer-events:none; }
  .brand .stamp{ background:var(--brand); color:#fff; padding:3px 10px; border-radius:0; font-weight:900 }
  .brand .mg{ font-style:italic; opacity:.95 }
.brand .powered{ font-weight:600; font-size:10px; opacity:.75; margin-left:6px; }

  .zoom{ display:flex; align-items:center; gap:8px; justify-self:end }
  #zoomPct{ width:48px; text-align:right; font-size:12px; opacity:.85 }

  .work{ display:grid; grid-template-columns: 320px 1fr; min-height:0 }
  .side{ background:var(--panel); border-right:1px solid #23252a; padding:12px; overflow:auto }
  .side h3{ margin:8px 0; font-size:14px; opacity:.9 }
  .group{ display:grid; gap:8px; margin:10px 0 16px }
  .muted{ opacity:.7; font-size:12px }

  #stageViewport{ position:relative; overflow:auto; padding:32px; display:grid; place-items:center; }
  #stageScroller{ width:max-content; height:max-content; }
  #stage{ position:relative; width:1600px; height:900px; background:#f7f7f8; box-shadow:0 20px 60px rgba(0,0,0,.5); overflow:hidden; }
  .el{ position:absolute; user-select:none; cursor:move; --tx:0px; --ty:0px; --rot:0deg; --sx:1; --sy:1;
       transform: translate3d(var(--tx),var(--ty),0) rotate(var(--rot)) scale(var(--sx), var(--sy)); transform-origin:center center; overflow:visible; }
  .el.selected{ outline:2px solid #4da3ff }
  .el img{ display:block; width:100%; height:100%; object-fit:contain; pointer-events:none }
  .el[data-type="text"] .tbox{ font-weight:900; line-height:1.05; display:inline-block; white-space:pre; min-width:40px; min-height:1em; }

  .handle{ position:absolute; width:12px; height:12px; background:#4da3ff; border-radius:50%; z-index:20; display:none }
  .el.selected .handle{ display:block }
  .h-tl{ left:-6px; top:-6px; cursor:nwse-resize }
  .h-tr{ right:-6px; top:-6px; cursor:nesw-resize }
  .h-br{ right:-6px; bottom:-6px; cursor:nwse-resize }
  .h-bl{ left:-6px; bottom:-6px; cursor:nesw-resize }
  .h-rot{ position:absolute; right:-22px; top:50%; width:24px; height:24px; margin-top:-12px; border-radius:50%; cursor:grab; background:#4da3ff; border:2px solid #fff; box-shadow:0 2px 5px rgba(0,0,0,.35); z-index:30; display:none }
  .el.selected .h-rot{ display:block }

  .stamp{ display:inline-block; background:var(--brand); color:#fff; font-weight:900; padding:.18em .5em; letter-spacing:.5px; border-radius:0 }
  #drawCanvas{ position:absolute; inset:0; pointer-events:none; z-index:5 }

  .bubble{ position:fixed; bottom:16px; right:16px; background:#141518; border:1px solid #2b2e34; border-radius:12px; padding:10px; display:flex; gap:8px; align-items:center; z-index:5000 }
  .bubble input[type=text]{ width:320px; background:#1e2025; border:1px solid #2b2e34; border-radius:10px; color:var(--ink); height:34px; padding:0 10px }

  .version{ position:fixed; left:12px; bottom:10px; font-size:12px; opacity:.6; pointer-events:none }

  #marquee{ position:fixed; border:1px dashed #4da3ff; background:rgba(77,163,255,.15); display:none; z-index:99999; pointer-events:none }

  /* === CLASSIC TOOLBAR === */
  #toolbarOverlay{ position:fixed; inset:0; pointer-events:none; z-index:4000 }
  .itb{ position:absolute; background:#fff; color:#111; border-radius:28px; box-shadow:0 18px 40px rgba(0,0,0,.35);
        display:flex; gap:18px; align-items:center; padding:12px 18px; cursor:grab; pointer-events:auto; }
  .itb.dragging{ cursor:grabbing }
  .itb .icon{ width:22px; height:22px; display:grid; place-items:center }
  .itb svg{ width:22px; height:22px; fill:#111 }
  .itb .slider{ appearance:none; width:180px; height:10px; border-radius:5px; background:#c7c7c7; outline:none; }
  .itb .slider::-webkit-slider-thumb{ -webkit-appearance:none; appearance:none; width:22px; height:22px; border-radius:50%; background:var(--pink); border:0; box-shadow: 0 0 0 4px rgba(255,79,176,.25); cursor:pointer }
  .itb .slider::-moz-range-thumb{ width:22px; height:22px; border-radius:50%; background:var(--pink); border:0; cursor:pointer }

  /* Help modal */
  .modalBack{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:6000 }
  .modal{ width:min(880px,92vw); background:#141518; border:1px solid #2b2e34; border-radius:16px; padding:18px; box-shadow:0 20px 80px rgba(0,0,0,.55) }
  .modal h2{ margin:0 0 6px; font-size:18px }
  .modal .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:14px; margin-top:10px }
  .kbd{ background:#1e2025; border:1px solid #2b2e34; border-radius:8px; padding:10px; font-size:13px }
  .modal .toprow{ display:flex; justify-content:space-between; align-items:center; gap:12px }
  .xbtn{ background:#23252a; border:1px solid #2f3238; color:var(--ink); border-radius:10px; padding:6px 10px; cursor:pointer }
</style>
</head>
<body>
<div class="app">
  <div class="top">
    <div style="display:flex;gap:8px;">
      <button class="btn" id="blank">Blank</button>
      <select id="tpl">
        <option value="none">Choose Template…</option>
        <option value="beforeAfter">Before / After</option>
        <option value="reaction">Hoodie Reaction</option>
        <option value="lieWeek">Lie of the Week</option>
        <option value="collage">Receipts Collage (2×2)</option>
        <option value="chart">Chart Dunk</option>
        <option value="villains">Villain Board (Top 6)</option>
        <option value="stampOnly">Stamp Only</option>
      </select>
      <button class="btn" id="undo">Undo</button>
      <button class="btn" id="redo">Redo</button>
      <button class="btn" id="helpBtn">?</button>
    </div>
    <div class="brand">
  <span class="mg">MEE•MO•MEE•MO•MEME MACHINE</span>
  <span class="powered">Powered by <span class="stamp">$LIED</span></span>
</div>
    <div class="zoom">
      <button class="btn" id="fit">Fit</button>
      <input type="range" id="zoom" min="1" max="200" value="50">
      <div id="zoomPct">50%</div>
      <button class="btn" id="export">Export PNG</button>
    </div>
  </div>

  <div class="work">
    <div class="side">
      <h3>Add</h3>
      <div class="group">
        <button class="btn" id="addText">Text</button>
        <button class="btn" id="addLogo">Logo</button>
        <button class="btn" id="addStamp">THEY LIED Stamp</button>
        <button class="btn" id="addMascot">Lerp</button>
        <input id="uploader" type="file" accept="image/*" multiple />
      </div>

      <h3>Arrange</h3>
      <div class="group">
        <button class="btn" id="forward">Bring Forward (+1)</button>
        <button class="btn" id="backward">Send Backward (−1)</button>
        <button class="btn" id="clear">Clear All</button>
      </div>

      <h3>Canvas</h3>
      <div class="group">
        <div>
          <select id="sizeSel">
            <option value="1600x900">Wide 1600×900</option>
            <option value="1920x1080">HD 1920×1080</option>
            <option value="2048x1152">YouTube 2048×1152</option>
            <option value="1080x1080">Square 1080×1080</option>
            <option value="1080x1920">Mobile 1080×1920</option>
          </select>
          <button class="btn" id="applySize">Apply</button>
        </div>
        <div style="display:flex;align-items:center;gap:8px;margin-top:8px;">
          <span class="muted">BG</span> <input type="color" id="bg" value="#f7f7f8" />
        </div>
      </div>

      <h3>Draw (Paint)</h3>
      <div class="group">
        <div style="display:flex;align-items:center;gap:8px;">
          <button class="btn" id="drawToggle">Enable Draw</button>
          <input type="color" id="brushColor" value="#000000" title="Brush color" />
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <span class="muted">Size</span>
          <input type="range" id="brushSize" min="2" max="80" value="14" />
          <button class="btn" id="clearDraw">Clear</button>
        </div>
        <div class="muted">While Draw is enabled, strokes are not auto-selected.</div>
      </div>
    </div>

    <div id="stageViewport">
      <div id="stageScroller">
        <div id="stage">
          <canvas id="drawCanvas"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- CLASSIC TOOLBAR -->
<div id="toolbarOverlay">
  <div id="itb" class="itb" style="display:none; left:50%; top:120px;">
    <div class="icon" id="itbDup" title="Duplicate">
      <svg viewBox="0 0 47.32 47.32"><path d="M13.52 20.28c0-3.73 3.03-6.76 6.76-6.76h20.28c3.73 0 6.76 3.03 6.76 6.76v20.28c0 3.73-3.03 6.76-6.76 6.76H20.28c-3.73 0-6.76-3.03-6.76-6.76z"></path><path d="M6.76 0C3.03 0 0 3.03 0 6.76v20.28c0 3.73 3.03 6.76 6.76 6.76V6.76H33.8C33.8 3.03 30.77 0 27.04 0z"></path></svg>
    </div>
    <div class="icon" title="Opacity">
      <svg viewBox="0 0 39.85 47.32"><path d="M19.92 47.32q-8.28 0-14.1-5.73T0 27.64c0-2.69.52-5.22 1.56-7.56a20.6 20.6 0 0 1 4.3-6.26L19.92 0l14.07 13.82a20.5 20.5 0 0 1 4.3 6.26q1.56 3.525 1.56 7.56 0 8.22-5.82 13.95t-14.1 5.73ZM5.11 29.89h29.51c.5-2.99.22-5.54-.84-7.66s-2.15-3.71-3.27-4.79L19.93 6.98 9.35 17.44c-1.12 1.08-2.22 2.68-3.3 4.79-1.08 2.12-1.39 4.67-.93 7.66Z"></path></svg>
    </div>
    <input id="itbOpacity" class="slider" type="range" min="10" max="100" value="100">
    <div class="icon" id="itbFlipV" title="Flip vertical">
      <svg viewBox="0 0 47.32 50.63"><path d="M0 22.95h47.32v4.73H0zm6.25 9.46h32.79v18.22zm0-14.19L39.04 0v18.22z"></path></svg>
    </div>
    <div class="icon" id="itbFlipH" title="Flip horizontal">
      <svg viewBox="0 0 50.63 47.32"><path d="M27.68 0v47.32h-4.73V0zm-9.46 6.25v32.79H0zm14.19 0 18.22 32.79H32.41z"></path></svg>
    </div>
    <div class="icon" id="itbDel" title="Delete">
      <svg viewBox="0 0 36.61 47.07"><path d="M36.61 2.62h-9.15L24.84 0H11.76L9.14 2.62H0v5.23h36.61zM2.62 41.84c0 2.89 2.34 5.23 5.23 5.23h20.92c2.89 0 5.23-2.34 5.23-5.23V10.46H2.62z"></path></svg>
    </div>
  </div>
</div>

<!-- Help modal -->
<div id="helpBack" class="modalBack">
  <div class="modal">
    <div class="toprow">
      <h2>They Lied MEE•MO•MEE•MO•MEME MACHINE — Help & Shortcuts</h2>
      <button class="xbtn" id="helpClose">Close</button>
    </div>
    <p class="muted" style="margin:6px 0 10px;">Quick guide to build memes fast. Works like Photoshop: proportional scaling by default, Shift to free‑distort, Alt/Option to scale from center.</p>
    <div class="grid">
      <div class="kbd">
        <strong>Selection & moving</strong><br>
        • Click to select, Shift‑click to multi‑select<br>
        • Drag empty canvas to marquee‑select<br>
        • Arrow keys to nudge (Shift = 10px)
      </div>
      <div class="kbd">
        <strong>Resize & rotate</strong><br>
        • Drag blue corner dots to scale (proportional by default)<br>
        • Hold <em>Shift</em> = free distort<br>
        • Hold <em>Alt/Option</em> = scale from center<br>
        • Drag the blue circle handle to rotate
      </div>
      <div class="kbd">
        <strong>Layers</strong><br>
        • Bring Forward / Send Backward move one step<br>
        • Repeat to reach top/bottom
      </div>
      <div class="kbd">
        <strong>Draw mode</strong><br>
        • Enable Draw to paint on the canvas<br>
        • Strokes become movable layers when you stop drawing<br>
        • Strokes only become selectable after you disable Draw
      </div>
      <div class="kbd">
        <strong>Text</strong><br>
        • Double‑click a text layer to edit in the bottom bar<br>
        • “Stamp Style” makes a red THEY LIED bar with white text
      </div>
      <div class="kbd">
        <strong>Export</strong><br>
        • Click “Export PNG” for a high‑quality image
      </div>
    </div>
  </div>
</div>

<div class="version" id="versionLabel"></div>
<div id="marquee"></div>

<div class="bubble" id="editor">
  <input type="text" id="txt" placeholder="Type text… (double‑click a text box first)" />
  <select id="fontFamily" title="Font">
    <option value="Impact, Arial Black, Inter, Arial, sans-serif">Impact</option>
    <option value="Anton, Impact, Arial Black, Inter, Arial, sans-serif">Anton</option>
    <option value="Arial Black, Impact, Inter, Arial, sans-serif">Arial Black</option>
    <option value="Inter, Arial, sans-serif">Inter</option>
    <option value="Arial, sans-serif">Arial</option>
  </select>
  <input type="number" id="fs" min="12" max="400" value="64" title="Font size" />
  <input type="color" id="fc" value="#000000" title="Color" />
    <label style="display:inline-flex;align-items:center;gap:6px;">    <input type="checkbox" id="outlineToggle" /> Outline  </label>
  <select id="outlineSize" title="Outline size">    <option value="2">Thin</option>    <option value="4" selected>Normal</option>    <option value="8">Thick</option>  </select>
  <input type="color" id="outlineColor" value="#000000" title="Outline color" />
<button class="btn" id="stampStyle">Stamp Style</button>
</div>

<script>
(function(){
  const VERSION = "4.7.10";
  document.getElementById('versionLabel').textContent = "They Lied MEE•MO•MEE•MO•MEME MACHINE " + VERSION;

  const ASSETS = {
    logo: "https://static.wixstatic.com/media/d7bc5f_9f109787e65c463d82461169f65dda33~mv2.png/v1/fill/w_784,h_784,al_c,q_90,usm_0.66_1.00_0.01,enc_avif,quality_auto/logo_2x.png",
    stampImg: "https://static.wixstatic.com/media/d7bc5f_e5d4a1012e8e4c46a206fb9bb975feef~mv2.png/v1/fill/w_1158,h_246,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/Middel%205_2x.png",
    mascot: "https://static.wixstatic.com/media/d7bc5f_a32ee7723b124d368056b6d6aa0a860b~mv2.png/v1/fill/w_630,h_630,al_c,q_90,usm_0.66_1.00_0.01,enc_avif,quality_auto/They%20Lied%20MAscot%201.png"
  };

  const stage = document.getElementById('stage');
  const scroller = document.getElementById('stageScroller');
  const viewport = document.getElementById('stageViewport');
  const drawCanvas = document.getElementById('drawCanvas');
  const dctx = drawCanvas.getContext('2d'); dctx.imageSmoothingEnabled=true; dctx.imageSmoothingQuality='high';
  const itb = document.getElementById('itb');
  let z=10, uploadCount=0, scale=1;
  let drawing=false;
  // === Undo/Redo (minimal hotfix) ===
  const __H = { past: [], future: [], t: null };
  function __snap(){
    return {
      els: Array.from(stage.querySelectorAll('.el')).map(n=>n.outerHTML).join(''),
      bg: stage.style.background,
      z
    };
  }
  function __bindEl(el){
    el.querySelectorAll('.handle').forEach(h=>{
      const cls=[...h.classList].find(v=>/^h\-/.test(v));
      const corner=cls && cls.split('-')[1];
      h.addEventListener('pointerdown',(e)=>startResize(e,el,corner));
    });
    const rot=el.querySelector('.h-rot');
    if(rot){ rot.addEventListener('pointerdown',(e)=>startRotate(e,el)); }
    el.addEventListener('pointerdown',(e)=>onElementPointerDown(e,el));
  }
  function __rebindAll(){ stage.querySelectorAll('.el').forEach(__bindEl); }
  function __restore(s){
    // Remove existing .el nodes only; leave canvas & sizing intact
    stage.querySelectorAll('.el').forEach(n=>n.remove());
    const tmp=document.createElement('div');
    tmp.innerHTML = s.els || '';
    [...tmp.children].forEach(n=>{ stage.appendChild(n); __bindEl(n); });
    stage.style.background = s.bg;
    z = s.z || z;
    clearSelection();
  }
  function __push(){ __H.past.push(__snap()); __H.future.length = 0; }
  function __schedulePush(){ clearTimeout(__H.t); __H.t = setTimeout(__push, 200); }


  // Help modal
  const helpBack = document.getElementById('helpBack');
  document.getElementById('helpBtn').onclick = ()=> helpBack.style.display='flex';
  document.getElementById('helpClose').onclick = ()=> helpBack.style.display='none';
  helpBack.addEventListener('click', (e)=>{ if(e.target===helpBack) helpBack.style.display='none'; });

  // Selection helpers
  let selection = new Set();
  function clearSelection(){ selection.forEach(el=>el.classList.remove('selected')); selection.clear(); hideToolbar(); }
  function addToSelection(el){ if(!selection.has(el)){ selection.add(el); el.classList.add('selected'); } showToolbarFor(el); }
  function setSingleSelection(el){ clearSelection(); if(el){ selection.add(el); el.classList.add('selected'); } showToolbarFor(el); }
  function isSelected(el){ return selection.has(el); }

  // Size / BG / Zoom
  function setSize(w,h){ stage.style.width=w+'px'; stage.style.height=h+'px'; drawCanvas.width=w; drawCanvas.height=h; }
  setSize(1600,900); stage.style.background='#f7f7f8';
  function applyZoom(s){ scale=Math.max(.01,Math.min(2,s)); scroller.style.transform=`scale(${scale})`; scroller.style.transformOrigin='top left'; zoom.value=Math.round(scale*100); zoomPct.textContent=Math.round(scale*100)+'%'; if(selection.size===1) showToolbarFor([...selection][0]); }
  const zoom=document.getElementById('zoom'), zoomPct=document.getElementById('zoomPct');
  zoom.oninput=e=>applyZoom(e.target.value/100);
  document.getElementById('fit').onclick=()=>{ const vw=viewport.clientWidth-32, vh=viewport.clientHeight-32; const w=stage.clientWidth,h=stage.clientHeight; applyZoom(Math.max(.5,Math.min(2,Math.min(vw/w,vh/h)))); };
  applyZoom(.5);
  document.getElementById('applySize').onclick=()=>{ const [w,h]=sizeSel.value.split('x').map(Number); setSize(w,h); applyZoom(.5); };
  const sizeSel=document.getElementById('sizeSel');
  document.getElementById('bg').oninput=e=>{ stage.style.background=e.target.value; __schedulePush(); };

  // Make element
  function mkEl(type, opts={}){
    const el=document.createElement('div');
    el.className='el'; el.dataset.type=type; el.style.left=(opts.x||40)+'px'; el.style.top=(opts.y||40)+'px'; el.style.zIndex=++z;
    if(type==='text'){
      const box=document.createElement('div'); box.className='tbox'; box.textContent=opts.text||'YOUR TEXT';
      box.style.fontFamily=opts.font||'Impact, Arial Black, Inter, Arial, sans-serif';
      box.style.fontSize=(opts.size||64)+'px'; box.style.color=opts.color||'#000'; el.appendChild(box); box.dataset.outline='0'; box.dataset.ocolor='#000000'; box.dataset.osize='4';
      requestAnimationFrame(()=>{ const w=Math.max(160, box.offsetWidth+2); el.style.width=w+'px'; el.style.height=box.offsetHeight+'px'; });
    } else {
      el.style.width=(opts.w||300)+'px'; el.style.height=(opts.h||300)+'px';
      const img=new Image(); img.crossOrigin='anonymous'; img.src=opts.src; img.style.width='100%'; img.style.height='100%'; img.style.display='block'; img.style.pointerEvents='none'; el.appendChild(img);
    }
    ['tl','tr','br','bl'].forEach(p=>{ const h=document.createElement('div'); h.className='handle h-'+p; el.appendChild(h); h.addEventListener('pointerdown',(e)=>startResize(e,el,p)); });
    const rot=document.createElement('div'); rot.className='h-rot'; el.appendChild(rot); rot.addEventListener('pointerdown',(e)=>startRotate(e,el));

    el.addEventListener('pointerdown',(e)=>onElementPointerDown(e,el));
    el.addEventListener('dblclick',()=>{ if(el.dataset.type==='text') openEditor(el); });

    stage.appendChild(el); if(opts.select!==false) setSingleSelection(el);
    if(type==='text' && opts.edit!==false) openEditor(el);
    __push(); return el;
  }

  // Toolbar (fixed overlay)
  function showToolbarFor(el){
    if(!el){ hideToolbar(); return; }
    const r=el.getBoundingClientRect();
    itb.style.left = (r.right + 14) + 'px';
    itb.style.top  = (r.top - 12) + 'px';
    itb.style.display='flex';
    document.getElementById('itbOpacity').value = Math.round(parseFloat(getComputedStyle(el).opacity)*100);
  }
  function hideToolbar(){ itb.style.display='none'; }
  itb.addEventListener('pointerdown', (e)=>{
    if(e.target.closest('svg') || e.target.closest('input')) return;
    itb.classList.add('dragging'); const startX=e.clientX, startY=e.clientY; const startL=parseFloat(itb.style.left)||0, startT=parseFloat(itb.style.top)||0;
    function move(ev){ itb.style.left=(startL+(ev.clientX-startX))+'px'; itb.style.top=(startT+(ev.clientY-startY))+'px'; }
    function up(){ window.removeEventListener('pointermove',move); window.removeEventListener('pointerup',up); itb.classList.remove('dragging');  __push();}
    window.addEventListener('pointermove',move); window.addEventListener('pointerup',up);
  });

  // Toolbar actions
  document.getElementById('itbDup').onclick = ()=> duplicateSelection();
  document.getElementById('itbDel').onclick = ()=> deleteSelection();
  document.getElementById('itbFlipH').onclick = ()=>{ if(!selection.size) return; selection.forEach(el=>{ const cur=parseFloat(el.style.getPropertyValue('--sx')||'1'); el.style.setProperty('--sx', cur===1? -1:1); }); };
  document.getElementById('itbFlipV').onclick = ()=>{ if(!selection.size) return; selection.forEach(el=>{ const cur=parseFloat(el.style.getPropertyValue('--sy')||'1'); el.style.setProperty('--sy', cur===1? -1:1); }); };
  document.getElementById('itbOpacity').oninput = (e)=>{ if(!selection.size) return; const v=(+e.target.value)/100; selection.forEach(el=> el.style.opacity=v); };

  // Marquee select
  stage.addEventListener('pointerdown', (e)=>{
    if(e.target!==stage || drawing) return;
    const startX=e.clientX, startY=e.clientY;
    marquee.style.left=startX+'px'; marquee.style.top=startY+'px'; marquee.style.width='0px'; marquee.style.height='0px'; marquee.style.display='block';
    function move(ev){ const x=Math.min(startX,ev.clientX), y=Math.min(startY,ev.clientY); const w=Math.abs(ev.clientX-startX), h=Math.abs(ev.clientY-startY); marquee.style.left=x+'px'; marquee.style.top=y+'px'; marquee.style.width=w+'px'; marquee.style.height=h+'px'; }
    function up(ev){
      marquee.style.display='none'; const r=marquee.getBoundingClientRect(); const st=stage.getBoundingClientRect();
      const sel={ left:(r.left-st.left)/scale, top:(r.top-st.top)/scale, right:(r.right-st.left)/scale, bottom:(r.bottom-st.top)/scale };
      clearSelection();
      [...stage.querySelectorAll('.el')].forEach(el=>{
        const l=parseFloat(el.style.left)||0, t=parseFloat(el.style.top)||0, w=el.clientWidth, h=el.clientHeight;
        const b={ left:l, top:t, right:l+w, bottom:t+h };
        if(b.left>=sel.left && b.right<=sel.right && b.top>=sel.top && b.bottom<=sel.bottom) addToSelection(el);
      });
      window.removeEventListener('pointermove',move); window.removeEventListener('pointerup',up);
    }
    window.addEventListener('pointermove',move); window.addEventListener('pointerup',up);
  });

  // Click / select
  function onElementPointerDown(e, el){
    if(drawing) return;
    if(e.shiftKey){ if(isSelected(el)){ el.classList.remove('selected'); selection.delete(el);} else addToSelection(el); }
    else if(!isSelected(el)) setSingleSelection(el);
    if(!e.target.classList.contains('handle') && !e.target.classList.contains('h-rot')) startDrag(e, el);
  }

  // Drag
  let dragState=null;
  function startDrag(e, el){
    const st=stage.getBoundingClientRect(); const sx=(e.clientX-st.left)/scale; const sy=(e.clientY-st.top)/scale;
    const els= selection.size? [...selection] : [el];
    dragState={ els, bases:els.map(n=>({el:n,left:parseFloat(n.style.left)||0, top:parseFloat(n.style.top)||0})), startX:sx, startY:sy };
    window.addEventListener('pointermove', dragging); window.addEventListener('pointerup', stopDrag);
  }
  function dragging(e){
    if(!dragState) return; const st=stage.getBoundingClientRect(); const sx=(e.clientX-st.left)/scale; const sy=(e.clientY-st.top)/scale;
    const dx=sx-dragState.startX, dy=sy-dragState.startY;
    dragState.bases.forEach(b=> { b.el.style.setProperty('--tx', dx+'px'); b.el.style.setProperty('--ty', dy+'px'); });
  }
  function stopDrag(){
    if(dragState){ const dx=parseFloat(dragState.bases[0].el.style.getPropertyValue('--tx'))||0; const dy=parseFloat(dragState.bases[0].el.style.getPropertyValue('--ty'))||0;
      dragState.bases.forEach(b=>{ b.el.style.left=(b.left+dx)+'px'; b.el.style.top=(b.top+dy)+'px'; b.el.style.setProperty('--tx','0px'); b.el.style.setProperty('--ty','0px'); });
    }
    dragState=null; window.removeEventListener('pointermove',dragging); window.removeEventListener('pointerup',stopDrag); __push();
  }

  // Resize (group + single)
  let res=null;
  function startResize(e, el, corner){ e.stopPropagation(); if(drawing) return;
    const st=stage.getBoundingClientRect();
    if(selection.size>1){
      const groupEls=[...selection]; const gb=getGroupBounds(groupEls);
      res={ mode:'group', corner, startX:(e.clientX-st.left)/scale, startY:(e.clientY-st.top)/scale, gb,
            els: groupEls.map(n=>({ el:n, left:parseFloat(n.style.left)||0, top:parseFloat(n.style.top)||0, w:n.clientWidth, h:n.clientHeight })) ,
            keepRatio: !e.shiftKey, fromCenter:e.altKey||e.metaKey };
    } else {
      const box=el.dataset.type==='text'? el.firstChild : null;
      res={ mode:'single', el, corner, startX:(e.clientX-st.left)/scale, startY:(e.clientY-st.top)/scale,
            left:parseFloat(el.style.left)||0, top:parseFloat(el.style.top)||0, w:el.clientWidth, h:el.clientHeight,
            keepRatio: !e.shiftKey, fromCenter:e.altKey||e.metaKey,
            baseFontSize: box? parseFloat(getComputedStyle(box).fontSize) : null, baseW:null };
      res.baseW = res.w;
    }
    try{ e.target.setPointerCapture(e.pointerId);}catch{}
    window.addEventListener('pointermove', doResize); window.addEventListener('pointerup', stopResize);
  }
  function doResize(e){
    if(!res) return; const st=stage.getBoundingClientRect(); const cx=(e.clientX-st.left)/scale; const cy=(e.clientY-st.top)/scale;
    let dx=cx-res.startX, dy=cy-res.startY;

    if(res.mode==='group'){
      let { left, top, width, height } = res.gb;
      let newL=left, newT=top, newW=width, newH=height;
      if(res.corner==='br'){ newW=width+dx; newH=height+dy; }
      if(res.corner==='tr'){ newW=width+dx; newH=height-dy; newT=top+dy; }
      if(res.corner==='bl'){ newW=width-dx; newH=height+dy; newL=left+dx; }
      if(res.corner==='tl'){ newW=width-dx; newH=height-dy; newL=left+dx; newT=top+dy; }
      newW=Math.max(40,newW); newH=Math.max(40,newH);
      if(res.keepRatio){ const r=width/height; const hFromW=newW/r, wFromH=newH*r; if(Math.abs(hFromW-newH)<Math.abs(wFromH-newW)) newH=hFromW; else newW=wFromH;
        if(['tl','bl'].includes(res.corner)) newL = left + (width - newW);
        if(['tl','tr'].includes(res.corner)) newT = top + (height - newH);
      }
      const sx=newW/width, sy=newH/height;
      res.els.forEach(o=>{
        const relX = (o.left - left), relY = (o.top - top);
        const nx = newL + relX*sx, ny = newT + relY*sy;
        o.el.style.left = nx+'px'; o.el.style.top = ny+'px';
        if(o.el.dataset.type==='text'){
          const box=o.el.firstChild; const fs = parseFloat(getComputedStyle(box).fontSize);
          const newFs = (fs * sx); box.style.fontSize = Math.max(8,newFs)+'px'; requestAnimationFrame(()=>{ o.el.style.width = Math.max(40, box.offsetWidth)+'px'; o.el.style.height = box.offsetHeight+'px'; });
        }else{
          o.el.style.width = Math.max(40, o.w*sx)+'px'; o.el.style.height = Math.max(40, o.h*sy)+'px';
        }
      });
      res.gb = { left:newL, top:newT, width:newW, height:newH };
      return;
    }

    // single
    let newL=res.left, newT=res.top, newW=res.w, newH=res.h;
    if(res.corner==='br'){ newW=res.w+dx; newH=res.h+dy; }
    if(res.corner==='tr'){ newW=res.w+dx; newH=res.h-dy; newT=res.top+dy; }
    if(res.corner==='bl'){ newW=res.w-dx; newH=res.h+dy; newL=res.left+dx; }
    if(res.corner==='tl'){ newW=res.w-dx; newH=res.h-dy; newL=res.left+dx; newT=res.top+dy; }
    newW=Math.max(40,newW); newH=Math.max(40,newH);
    if(res.keepRatio){ const r=res.w/res.h; const hFromW = newW/r; const wFromH = newH*r;
      if(Math.abs(hFromW-newH) < Math.abs(wFromH-newW)){ newH = hFromW; } else { newW = wFromH; }
      if(['tl','bl'].includes(res.corner)) newL = res.left + (res.w - newW);
      if(['tl','tr'].includes(res.corner)) newT = res.top + (res.h - newH);
    }
    if(res.fromCenter){ const cx0 = res.left + res.w/2; const cy0 = res.top + res.h/2; newL = cx0 - newW/2; newT = cy0 - newH/2; }
    if(res.el.dataset.type==='text'){
      const box=res.el.firstChild; const ratio = newW / res.baseW; const target = Math.max(8, res.baseFontSize * ratio);
      box.style.fontSize = target + 'px';
      requestAnimationFrame(()=>{ res.el.style.width = Math.max(40, box.offsetWidth)+'px'; res.el.style.height = box.offsetHeight+'px'; });
      res.el.style.left=newL+'px'; res.el.style.top=newT+'px';
    }else{
      res.el.style.left=newL+'px'; res.el.style.top=newT+'px'; res.el.style.width=newW+'px'; res.el.style.height=newH+'px';
    }
  }
  function stopResize(e){ if(res){ try{ e.target.releasePointerCapture && e.target.releasePointerCapture(e.pointerId);}catch{} } res=null; window.removeEventListener('pointermove',doResize); window.removeEventListener('pointerup',stopResize); __push(); }

  function getGroupBounds(els){
    const xs=[], ys=[], xe=[], ye=[];
    els.forEach(el=>{ const l=parseFloat(el.style.left)||0, t=parseFloat(el.style.top)||0, w=el.clientWidth, h=el.clientHeight; xs.push(l); ys.push(t); xe.push(l+w); ye.push(t+h); });
    const left=Math.min(...xs), top=Math.min(...ys), right=Math.max(...xe), bottom=Math.max(...ye);
    return { left, top, width:right-left, height:bottom-top };
  }

  // Rotate
  function angleBetween(cx,cy,px,py){ return Math.atan2(py-cy, px-cx)*180/Math.PI; }
  function startRotate(e, el){ e.stopPropagation(); if(drawing) return; const st=stage.getBoundingClientRect(); const r=el.getBoundingClientRect();
    const center={ x:(r.left+r.right)/2 - st.left, y:(r.top+r.bottom)/2 - st.top };
    const start = angleBetween(center.x, center.y, e.clientX - st.left, e.clientY - st.top);
    const base = parseFloat((el.style.getPropertyValue('--rot')||'0deg').replace('deg',''))||0;
    function move(ev){
      const a = angleBetween(center.x, center.y, ev.clientX - st.left, ev.clientY - st.top);
      el.style.setProperty('--rot', (base + (a-start)) + 'deg');
      showToolbarFor(el);
    }
    function up(){ window.removeEventListener('pointermove',move); window.removeEventListener('pointerup',up);  __push();}
    window.addEventListener('pointermove',move); window.addEventListener('pointerup',up);
  }

  // Text editor
  const txt=document.getElementById('txt'), fsInput=document.getElementById('fs'), fc=document.getElementById('fc'), fontFamily=document.getElementById('fontFamily'), stampStyle=document.getElementById('stampStyle');
  const outlineToggle=document.getElementById('outlineToggle'), outlineColor=document.getElementById('outlineColor'), outlineSize=document.getElementById('outlineSize');
  function openEditor(el){
    if(el&&el.dataset.type==='text'){ setSingleSelection(el); const b=el.firstChild;
      txt.value=b.textContent; fsInput.value=parseInt(getComputedStyle(b).fontSize); fc.value=rgb2hex(getComputedStyle(b).color); fontFamily.value=getComputedStyle(b).fontFamily;
      // Outline controls reflect dataset
      outlineToggle.checked = b.dataset.outline==='1';
      outlineColor.value = b.dataset.ocolor || '#000000';
      outlineSize.value = b.dataset.osize || '4';
    }
  }
  function rgb2hex(rgb){ const m=rgb.match(/\d+/g); if(!m) return '#000000'; return '#'+m.slice(0,3).map(n=>('0'+parseInt(n).toString(16)).slice(-2)).join(''); }
  txt.oninput=()=>{ const el=[...selection][0]; if(el&&el.dataset.type==='text'){ const b=el.firstChild; b.textContent=txt.value; requestAnimationFrame(()=>{ el.style.width=b.offsetWidth+'px'; el.style.height=b.offsetHeight+'px'; }); showToolbarFor(el); __schedulePush(); } };
  fsInput.oninput=()=>{ const el=[...selection][0]; if(el&&el.dataset.type==='text'){ const b=el.firstChild; b.style.fontSize=fsInput.value+'px'; requestAnimationFrame(()=>{ el.style.width=b.offsetWidth+'px'; el.style.height=b.offsetHeight+'px'; }); __schedulePush(); } };
  fc.oninput=()=>{ const el=[...selection][0]; if(el&&el.dataset.type==='text'){ el.firstChild.style.color=fc.value; __schedulePush(); } };
  fontFamily.onchange=()=>{ const el=[...selection][0]; if(el&&el.dataset.type==='text'){ const b=el.firstChild; b.style.fontFamily=fontFamily.value; requestAnimationFrame(()=>{ el.style.width=b.offsetWidth+'px'; el.style.height=b.offsetHeight+'px'; }); __push(); } };
  stampStyle.onclick=()=>{ const el=[...selection][0]; if(el&&el.dataset.type==='text'){ el.firstChild.classList.toggle('stamp'); el.firstChild.style.color='#fff'; __push(); } };
  function applyOutlineToBox(box){
    if(box.dataset.outline==='1'){
      const sz = parseFloat(box.dataset.osize||'4');
      const col = box.dataset.ocolor || '#000000';
      // CSS stroke for modern engines
      box.style.webkitTextStroke = sz + 'px ' + col;
      // Fallback using text-shadow approximated ring
      const s = sz;
      const sh = [];
      for (let x=-s; x<=s; x+=s){
        for (let y=-s; y<=s; y+=s){
          if(x===0 && y===0) continue;
          sh.push(x+'px '+y+'px 0 '+col);
        }
      }
      box.style.textShadow = sh.join(', ');
    }else{
      box.style.webkitTextStroke = '0px transparent';
      box.style.textShadow = 'none';
    }
  }
  outlineToggle.onchange = ()=>{ const el=[...selection][0]; if(el&&el.dataset.type==='text'){ const b=el.firstChild; b.dataset.outline = outlineToggle.checked ? '1' : '0'; applyOutlineToBox(b); __push(); } };
  outlineColor.oninput = ()=>{ const el=[...selection][0]; if(el&&el.dataset.type==='text'){ const b=el.firstChild; b.dataset.ocolor = outlineColor.value; if(b.dataset.outline==='1') applyOutlineToBox(b); __schedulePush(); } };
  outlineSize.onchange = ()=>{ const el=[...selection][0]; if(el&&el.dataset.type==='text'){ const b=el.firstChild; b.dataset.osize = outlineSize.value; if(b.dataset.outline==='1') applyOutlineToBox(b); __push(); } };


  // Add buttons
  document.getElementById('addText').onclick=()=> mkEl('text',{x:80,y:80});
  document.getElementById('addLogo').onclick=()=> mkEl('asset',{src:ASSETS.logo,w:220,h:220});
  document.getElementById('addStamp').onclick=()=> mkEl('asset',{src:ASSETS.stampImg,w:480,h:120});
  document.getElementById('addMascot').onclick=()=> mkEl('asset',{src:ASSETS.mascot,w:380,h:380});
  document.getElementById('uploader').onchange=(e)=>{ const files=[...e.target.files]; for(const f of files){ if(uploadCount>=5){ alert('Max 5 uploads'); break;} const url=URL.createObjectURL(f); const el=mkEl('img',{src:url,w:520,h:520}); el.dataset.upload='1'; uploadCount++; } e.target.value=''; };

  // Arrange — stepwise
  function zMap(){ return [...stage.querySelectorAll('.el')].sort((a,b)=>(parseInt(getComputedStyle(a).zIndex)||0)-(parseInt(getComputedStyle(b).zIndex)||0)); }
  function bringForwardStep(){
    if(!selection.size) return;
    const ordered=zMap();
    ordered.forEach((el,idx)=> el.dataset._order=idx);
    [...selection].sort((a,b)=> (a.dataset._order)-(b.dataset._order)).reverse().forEach(el=>{
      const idx=parseInt(el.dataset._order); if(idx>=ordered.length-1) return;
      const swap=ordered[idx+1];
      const zi=parseInt(getComputedStyle(el).zIndex)||1;
      const zj=parseInt(getComputedStyle(swap).zIndex)||1;
      el.style.zIndex = zj; swap.style.zIndex = zi;
     __push();});
  }
  function sendBackwardStep(){
    if(!selection.size) return;
    const ordered=zMap();
    ordered.forEach((el,idx)=> el.dataset._order=idx);
    [...selection].sort((a,b)=> (a.dataset._order)-(b.dataset._order)).forEach(el=>{
      const idx=parseInt(el.dataset._order); if(idx<=0) return;
      const swap=ordered[idx-1];
      const zi=parseInt(getComputedStyle(el).zIndex)||1;
      const zj=parseInt(getComputedStyle(swap).zIndex)||1;
      el.style.zIndex = zj; swap.style.zIndex = zi;
     __push();});
  }
  document.getElementById('forward').onclick=bringForwardStep;
  document.getElementById('backward').onclick=sendBackwardStep;

  function duplicateSelection(){ if(!selection.size) return; const clones=[]; selection.forEach(src=>{ const c=src.cloneNode(true); c.style.left=(parseInt(src.style.left||'0')+20)+'px'; c.style.top=(parseInt(src.style.top||'0')+20)+'px'; stage.appendChild(c);
    c.querySelectorAll('.handle').forEach(h=>{ const cls=[...h.classList].find(v=>/^h\-/.test(v)); const corner=cls&&cls.split('-')[1]; h.addEventListener('pointerdown',(e)=>startResize(e,c,corner)); });
    const rot=c.querySelector('.h-rot'); rot.addEventListener('pointerdown',(e)=>startRotate(e,c)); c.addEventListener('pointerdown',(e)=>onElementPointerDown(e,c)); clones.push(c); });
    clearSelection(); clones.forEach(addToSelection); __push(); }
  function deleteSelection(){ if(selection.size){ selection.forEach(el=>{ if(el.dataset.upload==='1') uploadCount=Math.max(0,uploadCount-1); el.remove();  __push();}); clearSelection(); } }
  document.getElementById('clear').onclick=()=>{ [...stage.querySelectorAll('.el')].forEach(n=>n.remove()); uploadCount=0; clearSelection(); dctx.clearRect(0,0,drawCanvas.width,drawCanvas.height); __push(); };

  // Keyboard
  document.addEventListener('keydown',(e)=>{
    const isInput=['INPUT','TEXTAREA','SELECT'].includes(document.activeElement.tagName);
    if(e.key==='Backspace'||e.key==='Delete'){ if(!isInput){ e.preventDefault(); deleteSelection(); } }
    if(!selection.size || isInput) return;
    let step=e.shiftKey?10:1; selection.forEach(el=>{ let l=parseFloat(el.style.left)||0,t=parseFloat(el.style.top)||0; if(e.key==='ArrowLeft') el.style.left=(l-step)+'px'; if(e.key==='ArrowRight') el.style.left=(l+step)+'px'; if(e.key==='ArrowUp') el.style.top=(t-step)+'px'; if(e.key==='ArrowDown') el.style.top=(t+step)+'px'; });
  });

  document.getElementById('undo').onclick = ()=>{
    if(__H.past.length > 1){
      const cur = __H.past.pop();
      __H.future.push(cur);
      __restore(__H.past[__H.past.length-1]);
    }
  };
  document.getElementById('redo').onclick = ()=>{
    if(__H.future.length){
      const s = __H.future.pop();
      __H.past.push(s);
      __restore(s);
    }
  };

  // Paint
  function setDraw(enabled){ drawing=enabled; drawCanvas.style.pointerEvents = enabled ? 'auto' : 'none'; drawCanvas.style.zIndex = enabled ? '9999' : '5'; document.getElementById('drawToggle').textContent = enabled ? 'Disable Draw' : 'Enable Draw'; }
  setDraw(false);
  function getRel(e){ const r=drawCanvas.getBoundingClientRect(); return { x:(e.clientX-r.left)/scale, y:(e.clientY-r.top)/scale }; }
  let path=[], bbox=null;
  drawCanvas.addEventListener('pointerdown', e=>{ if(!drawing) return; path=[]; const p=getRel(e); path.push(p);
    dctx.strokeStyle=document.getElementById('brushColor').value; dctx.lineWidth=document.getElementById('brushSize').value; dctx.lineCap='round'; dctx.lineJoin='round';
    dctx.beginPath(); dctx.moveTo(p.x,p.y); bbox={minX:p.x,minY:p.y,maxX:p.x,maxY:p.y,lw:dctx.lineWidth}; try{ drawCanvas.setPointerCapture(e.pointerId);}catch{} });
  drawCanvas.addEventListener('pointermove', e=>{ if(!drawing||!path.length) return; const p=getRel(e); path.push(p); dctx.lineTo(p.x,p.y); dctx.stroke(); bbox.minX=Math.min(bbox.minX,p.x); bbox.minY=Math.min(bbox.minY,p.y); bbox.maxX=Math.max(bbox.maxX,p.x); bbox.maxY=Math.max(bbox.maxY,p.y); });
  drawCanvas.addEventListener('pointerup', e=>{ if(!drawing||!path.length) return; dctx.closePath(); try{ drawCanvas.releasePointerCapture(e.pointerId);}catch{}
    const pad=bbox.lw/2+2; const x=Math.max(0,Math.floor(bbox.minX-pad)); const y=Math.max(0,Math.floor(bbox.minY-pad)); const w=Math.ceil((bbox.maxX+pad)-x); const h=Math.ceil((bbox.maxY+pad)-y);
    const off=document.createElement('canvas'); off.width=w; off.height=h; const o=off.getContext('2d'); o.imageSmoothingEnabled=true; o.imageSmoothingQuality='high'; o.strokeStyle=document.getElementById('brushColor').value; o.lineWidth=document.getElementById('brushSize').value; o.lineCap='round'; o.lineJoin='round';
    o.beginPath(); for(let i=0;i<path.length;i++){ const px=path[i].x-x, py=path[i].y-y; if(i===0) o.moveTo(px,py); else o.lineTo(px,py);} o.stroke(); o.closePath();
    dctx.clearRect(x,y,w,h); const url=off.toDataURL('image/png');
    mkEl('img',{x,y,w:Math.max(40,w),h:Math.max(40,h),src:url, select: false});
    path=[]; bbox=null;
  });
  document.getElementById('drawToggle').onclick=()=> setDraw(!drawing);
  document.getElementById('clearDraw').onclick=()=>{ dctx.clearRect(0,0,drawCanvas.width,drawCanvas.height); };

  // Export
  document.getElementById('export').onclick=async()=>{
    const w=drawCanvas.width,h=drawCanvas.height; const out=document.createElement('canvas'); out.width=w; out.height=h; const ctx=out.getContext('2d'); ctx.imageSmoothingEnabled=true; ctx.imageSmoothingQuality='high';
    ctx.fillStyle=getComputedStyle(stage).backgroundColor; ctx.fillRect(0,0,w,h);
    const els=[...stage.querySelectorAll('.el')].sort((a,b)=>(parseInt(getComputedStyle(a).zIndex)||0)-(parseInt(getComputedStyle(b).zIndex)||0));
    for(const el of els){
      ctx.save();
      const x=parseFloat(el.style.left)||0, y=parseFloat(el.style.top)||0, width=el.clientWidth, height=el.clientHeight;
      const rot=parseFloat((el.style.getPropertyValue('--rot')||'0deg').replace('deg',''))||0; const sx=parseFloat(el.style.getPropertyValue('--sx')||'1'); const sy=parseFloat(el.style.getPropertyValue('--sy')||'1'); const op=parseFloat(getComputedStyle(el).opacity)||1;
      ctx.globalAlpha = op;
      const cx=x+width/2, cy=y+height/2; ctx.translate(cx,cy); ctx.rotate(rot*Math.PI/180); ctx.scale(sx,sy); ctx.translate(-width/2,-height/2);
      if(el.dataset.type==='img' || el.dataset.type==='asset'){
        const img=el.querySelector('img'); await drawContained(ctx,img,0,0,width,height);
      }else if(el.dataset.type==='text'){
        const box=el.firstChild; const st=getComputedStyle(box); const isStamp=box.classList.contains('stamp');
        if(isStamp){ ctx.fillStyle=getComputedStyle(stage).getPropertyValue('--brand')||'#ca3028'; roundRect(ctx,0,0,box.offsetWidth+24,box.offsetHeight+12,0); ctx.fill(); ctx.fillStyle='#fff'; ctx.font=`900 ${parseInt(st.fontSize)}px ${st.fontFamily}`; ctx.textBaseline='top'; ctx.fillText(box.textContent,12,6); }
        else{ ctx.fillStyle=st.color; ctx.font=`900 ${parseInt(st.fontSize)}px ${st.fontFamily}`; ctx.textBaseline='top'; const lines = box.textContent.split('\\n'); const lh = parseInt(st.fontSize)*1.05; for(let i=0;i<lines.length;i++){ ctx.fillText(lines[i], 0, i*lh); } }
      }
      ctx.restore();
    }
    const url=out.toDataURL('image/png'); const a=document.createElement('a'); a.href=url; a.download='they_lied_meme.png'; a.click();
  };
  function drawContained(ctx,img,x,y,w,h){ return new Promise(res=>{ function go(){ try{ const iw=img.naturalWidth||img.width, ih=img.naturalHeight||img.height; if(iw&&ih){ const s=Math.min(w/iw,h/ih); const dw=iw*s, dh=ih*s; const dx=x+(w-dw)/2, dy=y+(h-dh)/2; ctx.drawImage(img,dx,dy,dw,dh);} }catch{} res(); } if(img.complete) go(); else { img.onload=go; img.onerror=res; } }); }
  function roundRect(ctx,x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }

  // Buttons
  document.getElementById('blank').onclick=()=>{ [...stage.querySelectorAll('.el')].forEach(n=>n.remove()); clearSelection(); __push(); };
  document.getElementById('tpl').onchange = (e)=> loadTemplate(e.target.value);
  function loadTemplate(t){
    document.getElementById('blank').click();
    if(t==='lieWeek'){
      mkEl('asset',{x:40,y:40,w:160,h:160,src:ASSETS.logo, select:false});
      mkEl('text',{x:230,y:60,text:'LIE OF\\nTHE\\nWEEK',size:164,select:false});
    } else if(t==='stampOnly'){
      mkEl('asset',{x:560,y:390,w:480,h:120,src:ASSETS.stampImg, select:false});
    } else if(t==='beforeAfter'){
      mkEl('text',{x:60,y:40,text:'\"It will never happen\"',size:72,select:false});
      mkEl('img',{x:60,y:140,w:700,h:520,src:'https://via.placeholder.com/700x520?text=BEFORE', select:false});
      mkEl('img',{x:840,y:140,w:700,h:520,src:'https://via.placeholder.com/700x520?text=AFTER', select:false});
      mkEl('asset',{x:680,y:780,w:260,h:120,src:ASSETS.stampImg, select:false});
    } else if(t==='reaction'){
      mkEl('text',{x:80,y:80,text:'They said it was dead…',size:96,select:false});
      mkEl('asset',{x:1060,y:420,w:380,h:380,src:ASSETS.mascot, select:false});
      mkEl('asset',{x:80,y:760,w:420,h:120,src:ASSETS.stampImg, select:false});
    } else if(t==='collage'){
      mkEl('text',{x:60,y:40,text:'Receipts',size:96,select:false});
      const pos=[[60,160],[840,160],[60,520],[840,520]];
      pos.forEach(p=> mkEl('img',{x:p[0],y:p[1],w:700,h:300,src:'https://via.placeholder.com/700x300?text=Receipt', select:false}));
      mkEl('asset',{x:640,y:760,w:320,h:320,src:ASSETS.logo, select:false});
    } else if(t==='chart'){
      mkEl('text',{x:60,y:60,text:'\"Top is in\" — 2023',size:80,select:false});
      mkEl('img',{x:120,y:160,w:1360,h:620,src:'https://via.placeholder.com/1360x620?text=Chart', select:false});
      mkEl('asset',{x:620,y:760,w:360,h:120,src:ASSETS.stampImg, select:false});
    } else if(t==='villains'){
      mkEl('text',{x:60,y:40,text:'Top Liars of the Week',size:84,select:false});
      const grid=[[80,160],[590,160],[1100,160],[80,520],[590,520],[1100,520]];
      grid.forEach((p,i)=> mkEl('img',{x:p[0],y:p[1],w:420,h:300,src:`https://via.placeholder.com/420x300?text=#${i+1}`, select:false}));
    }
  }

  // marquee box element from DOM
  const marquee = document.getElementById('marquee');

  // Utilities
  function wrapText(ctx,text,x,y,maxWidth,lh){ const words=text.split(' '); let line=''; for(let n=0;n<words.length;n++){ const test=line+words[n]+' '; if(ctx.measureText(test).width>maxWidth && n>0){ ctx.fillText(line,x,y); line=words[n]+' '; y+=lh; } else line=test; } ctx.fillText(line,x,y); }
  function rgb2hex(rgb){ const m=rgb.match(/\\d+/g); if(!m) return '#000000'; return '#'+m.slice(0,3).map(n=>('0'+parseInt(n).toString(16)).slice(-2)).join(''); }
  function drawContainedDummy(){}
__push();
})();
</script>
</body>
</html>
